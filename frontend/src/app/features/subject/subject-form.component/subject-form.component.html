<div class="container mt-4 mb-5">
  <div class="row justify-content-center">
    <div class="col-lg-10 col-xl-9">
      <!-- Form Card -->
      <div class="card shadow-sm border-0">
        <!-- Form Header with Gradient -->
        <div class="card-header text-white py-4 border-0 bg-primary">
          <h2 class="mb-2 fw-semibold">
            <i class="bi" [ngClass]="isEditMode ? 'bi-pencil-square' : 'bi-file-plus'"></i>
            @if (!isEditMode) {
            <span>Create New Subject</span>
            }
            @if (isEditMode) {
            <span>Edit Subject</span>
            }
          </h2>
          <p class="mb-0 opacity-90">
            @if (!isEditMode) {
            <span>Fill in the details below to add a new subject to the system</span>
            }
            @if (isEditMode) {
            <span>Update the subject information below</span>
            }
          </p>
        </div>

        <div class="card-body p-4">

          <!-- Error Alert -->
          @if (error) {
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Error:</strong> {{ error }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          }

          <!-- Main Form -->
          <form [formGroup]="subjectForm" (ngSubmit)="onSubmit()">

            <!-- Section 1: Basic Information -->
            <div class="mb-4">
              <div class="d-flex align-items-center mb-3 border-start border-primary border-4 ps-3">
                <h5 class="mb-0 fw-semibold text-dark">
                  <i class="bi bi-book text-primary me-2"></i>
                  Basic Information
                </h5>
              </div>

              <!-- Subject Name (Required) -->
              <div class="mb-3">
                <label for="subjectName" class="form-label fw-medium">
                  Subject Name
                  <span class="text-danger">*</span>
                </label>
                <input type="text" id="subjectName" formControlName="subjectName" class="form-control"
                  placeholder="e.g., Advanced Mathematics"
                  [class.is-invalid]="f['subjectName'].invalid && f['subjectName'].touched" />
                <div class="form-text">Enter the full name of the subject</div>
                @if (f['subjectName'].invalid && f['subjectName'].touched) {
                <div class="invalid-feedback d-block">
                  <i class="bi bi-exclamation-circle me-1"></i>
                  Subject name is required
                </div>
                }
              </div>

              <!-- Subject Code and Credits Row -->
              <div class="row">
                <!-- Subject Code -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="subjectCode" class="form-label fw-medium">Subject Code</label>
                    <input type="text" id="subjectCode" formControlName="subjectCode" class="form-control"
                      placeholder="e.g., MATH301" />
                    <div class="form-text">Optional course code</div>
                  </div>
                </div>

                <!-- Credits -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="credit" class="form-label fw-medium">Credits</label>
                    <input type="number" id="credit" formControlName="credit" class="form-control" placeholder="1-10"
                      min="1" max="10" [class.is-invalid]="f['credit'].invalid && f['credit'].touched" />
                    <div class="form-text">Value between 1 and 10</div>
                    @if (f['credit'].invalid && f['credit'].touched) {
                    <div class="invalid-feedback d-block">
                      <i class="bi bi-exclamation-circle me-1"></i>
                      Credits must be between 1 and 10
                    </div>
                    }
                  </div>
                </div>
              </div>
            </div>

            <!-- Section 2: Schedule Information (Legacy) -->
            <div class="mb-4 d-none"> <!-- Hidden as we move to new schedule -->
              <div class="d-flex align-items-center mb-3 border-start border-primary border-4 ps-3">
                <h5 class="mb-0 fw-semibold text-dark">
                  <i class="bi bi-clock text-primary me-2"></i>
                  Legacy Schedule
                </h5>
              </div>
              <div class="mb-3">
                <input type="datetime-local" formControlName="teachTime" class="form-control" />
                <input type="datetime-local" formControlName="endTime" class="form-control" />
                <select formControlName="dayOfWeek" class="form-select"></select>
              </div>
            </div>

            <!-- New Schedule Information -->
            <div class="mb-4">
              <div class="d-flex align-items-center mb-3 border-start border-primary border-4 ps-3">
                <h5 class="mb-0 fw-semibold text-dark">
                  <i class="bi bi-calendar-week text-primary me-2"></i>
                  Class Sessions (New)
                </h5>
              </div>

              <div formArrayName="sessions">
                <div *ngFor="let session of sessions.controls; let i=index" [formGroupName]="i"
                  class="card mb-3 bg-light">
                  <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                      <h6 class="card-title">Session {{i + 1}}</h6>
                      <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeSession(i)">
                        <i class="bi bi-trash"></i> Remove
                      </button>
                    </div>

                    <div class="row g-3">
                      <div class="col-md-3">
                        <label class="form-label small">Day</label>
                        <select formControlName="dayOfWeek" class="form-select form-select-sm">
                          <option value="">Select Day</option>
                          <option *ngFor="let day of daysOfWeek" [value]="day">{{day}}</option>
                        </select>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label small">Start Time</label>
                        <input type="time" formControlName="startTime" class="form-control form-control-sm">
                      </div>
                      <div class="col-md-3">
                        <label class="form-label small">End Time</label>
                        <input type="time" formControlName="endTime" class="form-control form-control-sm">
                      </div>
                      <div class="col-md-3">
                        <label class="form-label small">Room</label>
                        <input type="text" formControlName="room" class="form-control form-control-sm"
                          placeholder="Room 101">
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <button type="button" class="btn btn-outline-primary btn-sm" (click)="addSession()">
                <i class="bi bi-plus-circle me-1"></i> Add Session
              </button>
            </div>

            <!-- Section 3: Additional Information -->
            <div class="mb-4">
              <div class="d-flex align-items-center mb-3 border-start border-primary border-4 ps-3">
                <h5 class="mb-0 fw-semibold text-dark">
                  <i class="bi bi-info-circle text-primary me-2"></i>
                  Additional Information
                </h5>
              </div>

              <!-- Teacher ID -->
              <div class="mb-3">
                <label for="teacherId" class="form-label fw-medium">
                  <i class="bi bi-person-badge me-1"></i>
                  Teacher
                </label>
                <select id="teacherId" formControlName="teacherId" class="form-select">
                  <option value="">-- Select a teacher --</option>
                  @for (teacher of teachers; track teacher) {
                  <option [value]="teacher._id">
                    {{ teacher.name }} ({{ teacher._id }})
                  </option>
                  }
                </select>
                <div class="form-text">Select the teacher assigned to this subject</div>
              </div>

              <!-- Class Group Single (Legacy) -->
              <div class="mb-3 d-none">
                <select id="classGroup" formControlName="classGroup" class="form-select"></select>
              </div>

              <!-- Class Groups Multi -->
              <div class="mb-3">
                <label for="classGroups" class="form-label fw-medium">
                  <i class="bi bi-people me-1"></i>
                  Class Groups (Multiple)
                </label>
                <select id="classGroups" multiple formControlName="classGroups" class="form-select" size="5">
                  @for (group of classGroups; track group) {
                  <option [value]="group._id">
                    {{ group.name }}
                  </option>
                  }
                </select>
                <div class="form-text">Hold Ctrl/Cmd to select multiple class groups.</div>
              </div>

              <!-- Description -->
              <div class="mb-3">
                <label for="description" class="form-label fw-medium">
                  <i class="bi bi-card-text me-1"></i>
                  Description
                </label>
                <textarea id="description" formControlName="description" class="form-control" rows="5"
                  placeholder="Enter a detailed description of the subject, including topics covered, prerequisites, and learning objectives..."></textarea>
                <div class="form-text">
                  Provide a comprehensive description of the subject (optional)
                </div>
              </div>
            </div>

            <!-- Form Validation Summary -->
            @if (subjectForm.invalid && subjectForm.touched) {
            <div class="alert alert-warning" role="alert">
              <h6 class="alert-heading fw-semibold mb-2">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                Please fix the following errors:
              </h6>
              <ul class="mb-0 ps-4">
                @if (f['subjectName'].invalid && f['subjectName'].touched) {
                <li>
                  Subject name is required
                </li>
                }
                @if (f['credit'].invalid && f['credit'].touched) {
                <li>
                  Credits must be between 1 and 10
                </li>
                }
              </ul>
            </div>
            }

            <!-- Form Actions / Buttons -->
            <div class="d-flex justify-content-end gap-2 pt-3 border-top mt-4">
              <button type="button" class="btn btn-secondary px-4" (click)="cancel()" [disabled]="loading">
                <i class="bi bi-x-lg me-1"></i>
                Cancel
              </button>

              <button type="submit" class="btn btn-primary px-4" [disabled]="loading || subjectForm.invalid"
                style="border: none;">
                @if (!loading) {
                <span>
                  <i class="bi" [ngClass]="isEditMode ? 'bi-save' : 'bi-plus-lg'" style="margin-right: 0.5rem;"></i>
                  {{ isEditMode ? 'Update Subject' : 'Create Subject' }}
                </span>
                }
                @if (loading) {
                <span>
                  <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                  Saving...
                </span>
                }
              </button>
            </div>

          </form>

        </div>

        <!-- Help Section Footer -->
        <div class="card-footer bg-light border-0">
          <div class="alert alert-info mb-0 border-start border-info border-4" role="alert">
            <h6 class="alert-heading fw-semibold mb-2">
              <i class="bi bi-lightbulb me-2"></i>
              Helpful Tips
            </h6>
            <ul class="mb-0 ps-4 small">
              <li class="mb-1">Fields marked with <span class="text-danger">*</span> are required</li>
              <li class="mb-1">Subject code should be unique for each subject</li>
              <li class="mb-1">Make sure the end time is after the start time</li>
              <li class="mb-0">You can always edit the subject information later</li>
            </ul>
          </div>
        </div>

      </div>

    </div>
  </div>
</div>