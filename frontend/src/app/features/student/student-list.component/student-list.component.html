<div class="container-fluid py-4">
  <div class="row align-items-center mb-4">

    <!-- Title -->
    <div class="col-lg-8 col-md-8 col-12 mb-3 mb-lg-0">
      <h1 class="h2 mb-0">
        <i class="bi bi-people-fill text-primary me-2"></i>
        Students
      </h1>
      <p class="text-muted mb-0">
        Manage student information
      </p>
    </div>

    <!-- Action button -->
    @if (currentUser?.role === 'Admin') {
    <div class="col-lg-4 col-md-4 col-12 text-md-end text-start d-flex gap-2 justify-content-md-end">
      <input type="file" id="fileInput" (change)="onFileSelected($event)" accept=".xlsx, .xls" style="display: none;">
      <button (click)="triggerFileInput()" class="btn btn-success w-100 w-md-auto">
        <i class="bi bi-file-earmark-excel me-2"></i> Import
      </button>
      <button routerLink="/students/create" class="btn btn-primary w-100 w-md-auto">
        <i class="bi bi-plus-circle me-2"></i>
        Add Student
      </button>
    </div>
    }

  </div>


  <!-- Search Bar -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <div class="input-group">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input type="text" class="form-control" placeholder="Search by name, email, phone, or student ID..."
              [(ngModel)]="searchTerm" (input)="onSearch()" />
            @if (searchTerm) {
            <button class="btn btn-outline-secondary" type="button" (click)="clearSearch()">
              <i class="bi bi-x-lg"></i>
            </button>
            }
          </div>
        </div>
        <div class="col-md-3">
          <select class="form-select" [(ngModel)]="selectedLimit" (change)="onLimitChange()">
            <option [value]="10">10 per page</option>
            <option [value]="25">25 per page</option>
            <option [value]="50">50 per page</option>
            <option [value]="100">100 per page</option>
          </select>
        </div>
        <div class="col-md-3">
          <select class="form-select" [(ngModel)]="selectedSort" (change)="onSortChange()">
            <option value="createdAt-desc">Newest First</option>
            <option value="createdAt-asc">Oldest First</option>
            <option value="firstName-asc">Name (A-Z)</option>
            <option value="firstName-desc">Name (Z-A)</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  @if (loading) {
  <div class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Loading students...</p>
  </div>
  } @else {
  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">
                <i class="bi bi-person me-1"></i>
                Name
              </th>
              <th scope="col">
                <i class="bi bi-envelope me-1"></i>
                Email
              </th>
              <th scope="col">
                <i class="bi bi-telephone me-1"></i>
                Phone
              </th>
              <th scope="col">
                <i class="bi bi-gender-ambiguous me-1"></i>
                Gender
              </th>
              <th scope="col">
                <i class="bi bi-calendar2-event"></i>
                DOB
              </th>
              <th scope="col">
                <i class="bi bi-card-checklist"></i>
                Blacklist
              </th>
              <th scope="col" class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (student of students; track student._id) {
            <tr>
              <td class="align-middle">
                <div class="d-flex align-items-center">
                  @if (student.photo) {
                  <img [src]="student.photo" class="rounded-circle me-2" width="32" height="32" alt="Photo">
                  } @else {
                  <div
                    class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                    style="width: 32px; height: 32px;">
                    {{ student.firstName.charAt(0) }}{{ student.lastName.charAt(0) }}
                  </div>
                  }
                  <strong>{{ student.firstName }} {{ student.lastName }}</strong>
                </div>
              </td>
              <td class="align-middle">{{ student.user.email }}</td>
              <td class="align-middle">
                @if (student.phone) {
                <i class="bi bi-telephone-fill text-success me-1"></i>
                {{ student.phone }}
                } @else {
                <span class="text-muted">-</span>
                }
              </td>
              <td class="align-middle">
                @if (student.gender) {
                <span class="badge bg-secondary">{{ student.gender }}</span>
                } @else {
                <span class="text-muted">-</span>
                }
              </td>
              <td class="align-middle">
                {{ student.dob | date:'shortDate' }}
              </td>
              <td class="align-middle">
                @if (student.isBlacklisted) {
                <span class="badge bg-danger">Yes</span>
                } @else {
                <span class="badge bg-success">No</span>
                }
              </td>

              <td class="align-middle text-center">
                <div class="btn-group btn-group-sm">
                  <button [routerLink]="['/students', student._id]" class="btn btn-outline-primary"
                    title="View Details">
                    <i class="bi bi-eye"></i>
                  </button>
                  <button [routerLink]="['/students/edit', student._id]" class="btn btn-outline-success" title="Edit">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button (click)="deleteStudent(student._id, $event)" class="btn btn-outline-danger" title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            } @empty {
            <tr>
              <td colspan="7" class="text-center py-5">
                <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                @if (searchTerm) {
                <p class="text-muted mt-2">No students found matching "{{ searchTerm }}"</p>
                <button class="btn btn-primary btn-sm" (click)="clearSearch()">
                  <i class="bi bi-x-circle me-1"></i>
                  Clear Search
                </button>
                } @else {
                <p class="text-muted mt-2">No students found</p>
                <button routerLink="/students/create" class="btn btn-primary btn-sm">
                  <i class="bi bi-plus-circle me-1"></i>
                  Add First Student
                </button>
                }
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  @if (totalCount > 0) {
  <div class="row g-3 align-items-center mt-2">
    <!-- Info Section -->
    <div class="col-lg-6 col-12">
      <div class="d-flex align-items-center flex-wrap gap-2">
        <p class="text-muted mb-0">
          Showing <strong>{{ ((currentPage - 1) * limit) + 1 }}</strong> to
          <strong>{{ Math.min(currentPage * limit, totalCount) }}</strong> of
          <strong>{{ totalCount }}</strong> student(s)
        </p>
        @if (searchTerm) {
        <span class="badge bg-info">
          <i class="bi bi-search me-1"></i>Filtered
        </span>
        }
      </div>
    </div>

    <!-- Pagination Section -->
    <div class="col-lg-6 col-12">
      <nav aria-label="Student pagination">
        <ul class="pagination pagination-sm mb-0 justify-content-lg-end justify-content-center flex-wrap">
          <!-- Previous Button -->
          <li class="page-item" [class.disabled]="currentPage === 1">
            <button class="page-link d-flex align-items-center" (click)="prevPage()" [disabled]="currentPage === 1"
              aria-label="Previous page">
              <i class="bi bi-chevron-left"></i>
              <span class="d-none d-sm-inline ms-1">Previous</span>
            </button>
          </li>

          <!-- Page Numbers -->
          @for (page of getPageNumbers(); track page) {
          @if (page === '...') {
          <li class="page-item disabled d-none d-sm-block">
            <span class="page-link">...</span>
          </li>
          } @else {
          <li class="page-item" [class.active]="currentPage === page">
            <button class="page-link" (click)="goToPage(page)" [attr.aria-label]="'Go to page ' + page"
              [attr.aria-current]="currentPage === page ? 'page' : null">
              {{ page }}
            </button>
          </li>
          }
          }

          <!-- Next Button -->
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <button class="page-link d-flex align-items-center" (click)="nextPage()"
              [disabled]="currentPage === totalPages" aria-label="Next page">
              <span class="d-none d-sm-inline me-1">Next</span>
              <i class="bi bi-chevron-right"></i>
            </button>
          </li>
        </ul>
      </nav>
    </div>
  </div>
  }
  }
</div>