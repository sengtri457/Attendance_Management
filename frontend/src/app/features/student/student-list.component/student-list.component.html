<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h2 mb-0">
        <i class="bi bi-people-fill text-primary me-2"></i>
        Students
      </h1>
      <p class="text-muted mb-0">Manage student information</p>
    </div>
    @if (currentUser?.role === 'Admin') {
    <button routerLink="/students/create" class="btn btn-primary">
      <i class="bi bi-plus-circle me-2"></i>
      Add Student
    </button>
    }
  </div>

  <!-- Search Bar -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <div class="input-group">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input
              type="text"
              class="form-control"
              placeholder="Search by name, email, phone, or student ID..."
              [(ngModel)]="searchTerm"
              (input)="onSearch()"
            />
            @if (searchTerm) {
            <button class="btn btn-outline-secondary" type="button" (click)="clearSearch()">
              <i class="bi bi-x-lg"></i>
            </button>
            }
          </div>
        </div>
        <div class="col-md-3">
          <select class="form-select" [(ngModel)]="selectedLimit" (change)="onLimitChange()">
            <option [value]="10">10 per page</option>
            <option [value]="25">25 per page</option>
            <option [value]="50">50 per page</option>
            <option [value]="100">100 per page</option>
          </select>
        </div>
        <div class="col-md-3">
          <select class="form-select" [(ngModel)]="selectedSort" (change)="onSortChange()">
            <option value="createdAt-desc">Newest First</option>
            <option value="createdAt-asc">Oldest First</option>
            <option value="firstName-asc">Name (A-Z)</option>
            <option value="firstName-desc">Name (Z-A)</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  @if (loading) {
  <div class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Loading students...</p>
  </div>
  } @else {
  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">
                <i class="bi bi-person me-1"></i>
                Name
              </th>
              <th scope="col">
                <i class="bi bi-envelope me-1"></i>
                Email
              </th>
              <th scope="col">
                <i class="bi bi-telephone me-1"></i>
                Phone
              </th>
              <th scope="col">
                <i class="bi bi-gender-ambiguous me-1"></i>
                Gender
              </th>
              <th scope="col">
                <i class="bi bi-calendar2-event"></i>
                DOB
              </th>
              <th scope="col">
                <i class="bi bi-card-checklist"></i>
                Blacklist
              </th>
              <th scope="col" class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (student of students; track student._id) {
            <tr>
              <td class="align-middle">
                <div class="d-flex align-items-center">
                  @if (student.photo) {
                  <img [src]="student.photo" class="rounded-circle me-2" width="32" height="32" alt="Photo">
                  } @else {
                  <div
                    class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                    style="width: 32px; height: 32px;">
                    {{ student.firstName.charAt(0) }}{{ student.lastName.charAt(0) }}
                  </div>
                  }
                  <strong>{{ student.firstName }} {{ student.lastName }}</strong>
                </div>
              </td>
              <td class="align-middle">{{ student.user.email }}</td>
              <td class="align-middle">
                @if (student.phone) {
                <i class="bi bi-telephone-fill text-success me-1"></i>
                {{ student.phone }}
                } @else {
                <span class="text-muted">-</span>
                }
              </td>
              <td class="align-middle">
                @if (student.gender) {
                <span class="badge bg-secondary">{{ student.gender }}</span>
                } @else {
                <span class="text-muted">-</span>
                }
              </td>
              <td class="align-middle">
                {{ student.dob | date:'shortDate' }}
              </td>
              <td class="align-middle">
                @if (student.isBlacklisted) {
                <span class="badge bg-danger">Yes</span>
                } @else {
                <span class="badge bg-success">No</span>
                }
              </td>

              <td class="align-middle text-center">
                <div class="btn-group btn-group-sm">
                  <button [routerLink]="['/students', student._id]" class="btn btn-outline-primary"
                    title="View Details">
                    <i class="bi bi-eye"></i>
                  </button>
                  <button [routerLink]="['/students/edit', student._id]" class="btn btn-outline-success" title="Edit">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button (click)="deleteStudent(student._id, $event)" class="btn btn-outline-danger" title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            } @empty {
            <tr>
              <td colspan="7" class="text-center py-5">
                <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                @if (searchTerm) {
                <p class="text-muted mt-2">No students found matching "{{ searchTerm }}"</p>
                <button class="btn btn-primary btn-sm" (click)="clearSearch()">
                  <i class="bi bi-x-circle me-1"></i>
                  Clear Search
                </button>
                } @else {
                <p class="text-muted mt-2">No students found</p>
                <button routerLink="/students/create" class="btn btn-primary btn-sm">
                  <i class="bi bi-plus-circle me-1"></i>
                  Add First Student
                </button>
                }
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  @if (totalCount > 0) {
  <div class="d-flex justify-content-between align-items-center mt-3">
    <p class="text-muted mb-0">
      Showing {{ ((currentPage - 1) * limit) + 1 }} to {{ Math.min(currentPage * limit, totalCount) }} of {{ totalCount }} student(s)
      @if (searchTerm) {
        <span class="badge bg-info ms-2">
          <i class="bi bi-search me-1"></i>Filtered
        </span>
      }
    </p>
    <nav>
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item" [class.disabled]="currentPage === 1">
          <button class="page-link" (click)="goToPage(1)" [disabled]="currentPage === 1">
            <i class="bi bi-chevron-double-left"></i>
          </button>
        </li>
        <li class="page-item" [class.disabled]="currentPage === 1">
          <button class="page-link" (click)="prevPage()" [disabled]="currentPage === 1">
            <i class="bi bi-chevron-left"></i> Previous
          </button>
        </li>

        @for (page of getPageNumbers(); track page) {
          @if (page === '...') {
            <li class="page-item disabled">
              <span class="page-link">...</span>
            </li>
          } @else {
            <li class="page-item" [class.active]="currentPage === page">
              <button class="page-link" (click)="goToPage(page)">{{ page }}</button>
            </li>
          }
        }

        <li class="page-item" [class.disabled]="currentPage === totalPages">
          <button class="page-link" (click)="nextPage()" [disabled]="currentPage === totalPages">
            Next <i class="bi bi-chevron-right"></i>
          </button>
        </li>
        <li class="page-item" [class.disabled]="currentPage === totalPages">
          <button class="page-link" (click)="goToPage(totalPages)" [disabled]="currentPage === totalPages">
            <i class="bi bi-chevron-double-right"></i>
          </button>
        </li>
      </ul>
    </nav>
  </div>
  }
  }
</div>
